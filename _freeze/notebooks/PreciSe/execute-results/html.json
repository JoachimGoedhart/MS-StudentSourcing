{
  "hash": "5db5298cd6d49d0d83416dd7012ca072",
  "result": {
    "markdown": "---\ntitle: The percentage of cells in the S-phase\nauthor: \"Joachim Goedhart\"\nformat: html\n---\n\n\n## About\n\nWe summarize and display the data that is measured by students in the course \"Cellulaire Oncologie\". HeLa cells were incubated with EdU and subjected to click chemistry to label the cells in the S-phase. The students analyzed the images by hand and with an image analysis procedure (based on thresholding and particle analysis) in ImageJ/FIJI.\n\nThe data of each student is submitted through a Google Form and collected in a Google Sheet. The students also provide information on the group that they are in, as the group is treated as an independent variable.\n\nFirst, we load the necessary R packages for data handling and plotting:\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\n#| echo: false\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──\n✔ ggplot2 3.4.0     ✔ purrr   0.3.4\n✔ tibble  3.1.7     ✔ dplyr   1.0.9\n✔ tidyr   1.2.0     ✔ stringr 1.4.0\n✔ readr   2.1.2     ✔ forcats 0.5.1\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| echo: false\nlibrary(ggbeeswarm)\nsource(\"geom_flat_violin.R\")\n```\n:::\n\n\nNext, we read the data from the Google Sheet and modify the column names:\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ndf_sheet <- read.csv(\"https://docs.google.com/spreadsheets/d/e/2PACX-1vQztaYnSPoe_meMwCIOxBZ7QsWgF-C3ChVM7YqWsHjkGvd51-vB442lOCC_zusWkLw-kaEJJf1bLYz6/pub?output=csv\", na.strings = \"\")\ndf_sheet <- df_sheet %>% na.omit()\n\ncolnames(df_sheet) <- c(\"Timestamp\", \"Group\", \"manual\", \"automated\")\ndf_tidy <-\n    pivot_longer(\n        df_sheet,\n        cols = -c(\"Timestamp\", \"Group\"),\n        names_to = \"Analysis\",\n        values_to = \"S_phase\"\n    ) %>% mutate(S_phase = gsub(\" \", \"\", S_phase))\n```\n:::\n\n\nWe do some cleaning to make sure that we have numbers only and that the values are in the appropriate range (0%-100%):\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ndf_clean <- df_tidy %>% mutate(S_phase = as.numeric(S_phase)) %>% filter(S_phase>0 & S_phase<100)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning in mask$eval_all_mutate(quo): NAs introduced by coercion\n```\n\n\n:::\n:::\n\n\nThe column with Timestamp data are split, to have individual columns for the day, month and year:\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ndf <- df_clean %>% separate('Timestamp', c(\"Date\", \"Time\"), sep=\" \") %>%\n    separate('Date', c(\"day\", \"month\", \"year\"), sep=\"-\", convert = TRUE)\n```\n:::\n\n\n## Visualization\n\nWe can make a first plot that shows the distribution of the values for both type of analyses. This will give some impression of an average percentage of cells that are in the S-phase:\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\n        p <- ggplot(df, aes(x=S_phase, fill=Analysis))\n\n        p <- p + geom_density(alpha=0.8, color='grey20')\n\n        p <- p + labs(y=\"Count\", x=\"S-phase [%]\")\n\n        p <- p + coord_cartesian(xlim = c(0,100))\n\n        p <- p + theme_light(base_size = 16) + theme(axis.text.y = element_blank())\n        p <- p + facet_wrap(~Analysis)\n        p <- p + theme(legend.position = \"none\")\n        \n        p\n```\n\n::: {.cell-output-display}\n![](PreciSe_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nThe distributions for the automated and manual analysis look similar. Since every student did the analysis by hand and in automated fashion, we can directly compare these 'paired' data and we split it for the different years:\n\n\n::: {#cell-fig-paired-data .cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\n#| label: fig-paired-data\n#| fig-cap: \"Comparing the manual and automated analysis.\"\n        p <- ggplot(df, aes(x=Analysis, y=S_phase))\n\n        p <- p + geom_point(alpha=0.3)  +\n          geom_line(aes(group=Time), alpha=0.3) +\n          stat_summary(fun = median, geom = \"point\", size=6, shape=21, fill=\"grey\", alpha=0.9)\n        p <- p + labs(x=\"\", y=\"S-phase [%]\")\n\n        p <- p + coord_cartesian(ylim = c(0,100))\n\n        p <- p + theme_light(base_size = 16) \n        p <- p + facet_wrap(~year)\n        p\n```\n\n::: {.cell-output-display}\n![Comparing the manual and automated analysis.](PreciSe_files/figure-html/fig-paired-data-1.png){#fig-paired-data width=672}\n:::\n:::\n\n\nEach paired measurement is connected with a line and the slopes of the line vary substantially. Still, the average value (the large grey dot) for the two different counting methods is similar for each year. There is a difference for the averages between years, and this may be true biological variation between the cell cultures.\n\nTo get a fair estimate of the percentage of cells in the S-phase, we treat treat each group in each year as an independent measurement. Each of these independent measurements consists of multiple measurements (technical replicates) and we can plot this in a 'superplot' style, see also [Lord at al. (2020)](\nhttps://doi.org/10.1083/jcb.202001064). The individual measurements are shown as small dots and their median as a large dot:\n\n\n::: {#cell-fig-superplot-all .cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\n#| label: fig-superplot-all\n#| fig-cap: \"The percentage of HeLa cells in S-phase, presented as a superplot\"\np <- ggplot(df, aes(x=Group, y=S_phase, color=Group))\np <- p + geom_quasirandom() +  stat_summary(fun = mean, geom = \"point\", size=6, color=\"black\", alpha=0.5)\n        \np <- p + labs(x=\"Group\", y=\"S-phase [%]\")\np <- p + coord_cartesian(ylim = c(0,100))\n        \np <- p + theme_light(base_size = 16)\np <- p + theme(legend.position = \"none\") + facet_grid(Analysis~year)\n\np\n```\n\n::: {.cell-output-display}\n![The percentage of HeLa cells in S-phase, presented as a superplot](PreciSe_files/figure-html/fig-superplot-all-1.png){#fig-superplot-all width=672}\n:::\n:::\n\n\nWe consider the manual analysis (nuclei counted by hand) as the ground truth. So I only select the manually processed data:\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ndf_manual <- df %>% filter(Analysis == 'manual')\n```\n:::\n\n\nNext, I merge the date and group data, as this will give a column that reflects independent measurements:\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ndf_results <- df_manual %>% unite(Replicate, c(year, Group), sep=\" \")\n```\n:::\n\n\nThis data set will be saved, as it can be used as input for [SuperPlotsOfData](https://doi.org/10.1091/mbc.E20-09-0583):\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ndf_results %>% write.csv(\"results_S-phase.csv\")\n```\n:::\n\n\nThe [SuperPlotsOfData app](https://huygens.science.uva.nl/SuperPlotsOfData/) plots the data and calculates the statistics. We can repeat the calculations and the data analysis here. First we generate a dataframe that summarizes all individual measurements per independent measurement (defined by the column 'Replicate'): \n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ndf_summary <- df_results %>% group_by(Replicate, Analysis) %>% summarize(n=n(), Percentage=mean(S_phase))\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`summarise()` has grouped output by 'Replicate'. You can override using the\n`.groups` argument.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\ndf_summary\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 12 × 4\n# Groups:   Replicate [12]\n   Replicate Analysis     n Percentage\n   <chr>     <chr>    <int>      <dbl>\n 1 2021 A    manual      13       38.7\n 2 2021 B    manual      11       36.5\n 3 2021 C    manual      14       43.7\n 4 2021 D    manual      11       33.7\n 5 2022 A    manual      10       38.0\n 6 2022 B    manual       8       36.2\n 7 2022 C    manual      11       41.1\n 8 2022 D    manual       8       41.4\n 9 2023 A    manual       9       40.0\n10 2023 B    manual       7       35.6\n11 2023 C    manual       6       32.4\n12 2023 D    manual       9       22.5\n```\n\n\n:::\n:::\n\n\nWe can use these data to calculate a precise estimate of the percentage of HeLa cells in the S-phase:\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ndf_S <- df_summary %>% ungroup() %>% summarise(N=n(),\n                                               Average = mean(Percentage),\n                                               sd = sd(Percentage, na.rm = TRUE)) %>%\n  mutate(sem = sd / sqrt(N - 1),\n         mean_CI_lo = Average + qt((1-0.95)/2, N - 1) * sem,\n         mean_CI_hi = Average - qt((1-0.95)/2, N - 1) * sem)\n```\n:::\n\n\nThese are the resulting statistics:\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\ndf_S %>% select(-c('sd', 'sem')) %>% round(1)  %>% unite(`95% CI`, c(mean_CI_lo, mean_CI_hi), sep=\" - \")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 3\n      N Average `95% CI` \n  <dbl>   <dbl> <chr>    \n1    12    36.7 33 - 40.3\n```\n\n\n:::\n:::\n\n\nLet's now generate a superplot for the individual replicates, repeating what can be done in the app with the data in `results_S-phase.csv``. First we generate dotplots from the replicates:\n\n\n::: {.cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\np <- ggplot(df_results, (aes(x=Analysis, y=S_phase, color=Replicate, fill=Replicate)))\n\np <- p + geom_quasirandom(width = .2, varwidth = FALSE, cex=2, alpha=0.8, groupOnX=TRUE)\n\np <- p + facet_grid(.~Replicate)\np <- p + theme_light(base_size = 12) + theme(panel.grid.minor = element_blank())\np <- p + theme(legend.position=\"none\")\n\np\n```\n\n::: {.cell-output-display}\n![](PreciSe_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\nWe add the summary statistic for each replicate as a large dot. And with some styling (adjusting colors, labels), we generate the superplot:\n\n\n::: {#cell-fig-superplot .cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\n#| label: fig-superplot\n#| fig-cap: \"Data on the percentage of cells in e S-phase based on manual analysis. Each group & year defines an independent observations and is shown as dotplot and the distribution. The larger dot reflects the median value.\"\np <- p + geom_flat_violin(color=NA, scale = \"width\", width=0.6,position = position_nudge(x = .25, y = 0), trim=FALSE, alpha = 0.8)\n\np <-  p + stat_summary(fun = mean, geom = \"point\", shape=21, stroke = .3, size=4, color=\"black\", alpha=1)\n\np <- p + scale_fill_viridis_d(begin=0.3, end=0.7)\np <- p + scale_color_viridis_d(begin=0.3, end=0.7) \np <- p + labs(x=\"Replicate\", y=\"S-phase [%]\")\np <- p + theme(axis.text.x = element_blank())\n\np\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: Using the `size` aesthietic with geom_polygon was deprecated in ggplot2 3.4.0.\nℹ Please use the `linewidth` aesthetic instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![Data on the percentage of cells in e S-phase based on manual analysis. Each group & year defines an independent observations and is shown as dotplot and the distribution. The larger dot reflects the median value.](PreciSe_files/figure-html/fig-superplot-1.png){#fig-superplot width=672}\n:::\n:::\n\n\n\nTo visualize the individual independent values, with a unique color per year we can make a dotplot. The dotplot will be more valuable and informative when we have accumulated more data:\n\n\n::: {#cell-fig-histogram .cell warning.hidden='true' message.hidden='true'}\n\n```{.r .cell-code .hidden}\n#| label: fig-histogram\n#| fig-cap: \"A distribution of the results. Each dot represents an independent observation, based on the average of a group. The dots are color-coded according to the different years.\"\ndf_summary %>% \n  separate(Replicate, c(\"year\",\"group\"), sep=\" \") %>%\n  ggplot(aes(x=Percentage, fill=year))+geom_dotplot(dotsize = 1, stackgroups = TRUE, binwidth = 1, method = \"histodot\")+xlim(20,50)\n```\n\n::: {.cell-output-display}\n![A distribution of the results. Each dot represents an independent observation, based on the average of a group. The dots are color-coded according to the different years.](PreciSe_files/figure-html/fig-histogram-1.png){#fig-histogram width=672}\n:::\n:::\n",
    "supporting": [
      "PreciSe_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}